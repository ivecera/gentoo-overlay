From e7eac7791268b15c1ee10fb3faa9595f11f7d849 Mon Sep 17 00:00:00 2001
From: Root <root@cera.cz>
Date: Mon, 6 Feb 2017 16:09:32 +0100
Subject: [PATCH] 01

---
 vmci-only/linux/vmciKernelIf.c | 6 ++++++
 vmmon-only/linux/hostif.c      | 4 +++-
 vmnet-only/userif.c            | 4 +++-
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/vmci-only/linux/vmciKernelIf.c b/vmci-only/linux/vmciKernelIf.c
index e119f4e..2609250 100644
--- a/vmci-only/linux/vmciKernelIf.c
+++ b/vmci-only/linux/vmciKernelIf.c
@@ -2056,6 +2056,12 @@ VMCIHost_GetUserMemory(VA64 produceUVA,       // IN
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 99)
    retval = get_user_pages((VA)produceUVA,
                            produceQ->kernelIf->numPages,
+                           0,
+                           produceQ->kernelIf->u.h.headerPage,
+                           NULL);
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 99)
+   retval = get_user_pages((VA)produceUVA,
+                           produceQ->kernelIf->numPages,
                            1, 0,
                            produceQ->kernelIf->u.h.headerPage,
                            NULL);
diff --git a/vmmon-only/linux/hostif.c b/vmmon-only/linux/hostif.c
index 5f7fad2..94f3e8d 100644
--- a/vmmon-only/linux/hostif.c
+++ b/vmmon-only/linux/hostif.c
@@ -1163,7 +1163,9 @@ HostIFGetUserPages(void *uvAddr,          // IN
    int retval;
 
    down_read(&current->mm->mmap_sem);
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 99)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 9, 0)
+   retval = get_user_pages((unsigned long)uvAddr, numPages, 0, ppages, NULL);
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 99)
    retval = get_user_pages((unsigned long)uvAddr, numPages, 0, 0, ppages,
                            NULL);
 #else
diff --git a/vmnet-only/userif.c b/vmnet-only/userif.c
index 76dc6d3..f02e67a 100644
--- a/vmnet-only/userif.c
+++ b/vmnet-only/userif.c
@@ -113,7 +113,9 @@ UserifLockPage(VA addr) // IN
    int retval;
 
    down_read(&current->mm->mmap_sem);
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 99)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 9, 0)
+   retval = get_user_pages(addr, 1, 0, &page, NULL);
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 99)
    retval = get_user_pages(addr, 1, 1, 0, &page, NULL);
 #else
    retval = get_user_pages(current, current->mm, addr,
-- 
2.10.2

